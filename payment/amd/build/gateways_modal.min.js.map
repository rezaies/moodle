{"version":3,"sources":["../src/gateways_modal.js"],"names":["registerEventListeners","nodeSelector","rootNode","document","querySelector","addEventListener","e","preventDefault","show","focusOnClose","target","Templates","render","done","content","ModalFactory","create","type","types","SAVE_CANCEL","title","body","modal","getRoot","currency","dataset","gateways","context","gateway","push","html","js","replaceNodeContents","find","Selectors","regions","gatewaysContainer","on","ModalEvents","hidden","destroy","focus","save","root","values","value","processPayment","amount","component","componentid","description","success","message","hide","Notification","addNotification","location","reload","alert","then","callback","paymentMethod","process"],"mappings":"6lBAwBA,OACA,OAGA,OACA,OAEA,O,khEAOsC,QAAzBA,CAAAA,sBAAyB,CAACC,CAAD,CAAkB,CACpD,GAAMC,CAAAA,CAAQ,CAAGC,QAAQ,CAACC,aAAT,CAAuBH,CAAvB,CAAjB,CAEAC,CAAQ,CAACG,gBAAT,CAA0B,OAA1B,CAAmC,SAACC,CAAD,CAAO,CACtCA,CAAC,CAACC,cAAF,GACAC,CAAI,CAACN,CAAD,CAAW,CAACO,YAAY,CAAEH,CAAC,CAACI,MAAjB,CAAX,CACP,CAHD,CAIH,C,IASKF,CAAAA,CAAI,CAAG,SAACN,CAAD,CAEF,8DAAP,EAAO,KADPO,YACO,CADPA,CACO,YADQ,IACR,GACPE,UAAUC,MAAV,CAAiB,6BAAjB,CAAgD,EAAhD,EACCC,IADD,CACM,SAAAC,CAAO,CAAI,CACbC,UAAaC,MAAb,CAAoB,CAChBC,IAAI,CAAEF,UAAaG,KAAb,CAAmBC,WADT,CAEhBC,KAAK,CAAE,iBAAU,mBAAV,CAA+B,cAA/B,CAFS,CAGhBC,IAAI,CAAEP,CAHU,CAApB,EAKCD,IALD,CAKM,SAASS,CAAT,CAAgB,CAClB,qBAAeA,CAAK,CAACC,OAAN,GAAgB,CAAhB,CAAf,EACA,GAAMC,CAAAA,CAAQ,CAAGtB,CAAQ,CAACuB,OAAT,CAAiBD,QAAlC,CACA,oCAA8BA,CAA9B,EACCX,IADD,CACM,SAAAa,CAAQ,CAAI,IACRC,CAAAA,CAAO,CAAG,CACZD,QAAQ,CAAE,EADE,CADF,KAKMA,CALN,QAKd,2BAA8B,IAArBE,CAAAA,CAAqB,SAC1BD,CAAO,CAACD,QAAR,CAAiBG,IAAjB,CAAsBD,CAAtB,CACH,CAPa,+BASdjB,UAAUC,MAAV,CAAiB,uBAAjB,CAA0Ce,CAA1C,EACKd,IADL,CACU,SAACiB,CAAD,CAAOC,CAAP,CAAc,CAChBpB,UAAUqB,mBAAV,CAA8BV,CAAK,CAACC,OAAN,GAAgBU,IAAhB,CAAqBC,UAAUC,OAAV,CAAkBC,iBAAvC,CAA9B,CACIN,CADJ,CACUC,CADV,CAEH,CAJL,CAKH,CAfD,EAiBAT,CAAK,CAACC,OAAN,GAAgBc,EAAhB,CAAmBC,CAAW,CAACC,MAA/B,CAAuC,UAAW,CAE9CjB,CAAK,CAACkB,OAAN,GACA,GAAI,CACA/B,CAAY,CAACgC,KAAb,EACH,CAAC,MAAOnC,CAAP,CAAU,CAEX,CACJ,CARD,EAUAgB,CAAK,CAACC,OAAN,GAAgBc,EAAhB,CAAmBC,CAAW,CAACI,IAA/B,CAAqC,SAASpC,CAAT,CAAY,IACvCqC,CAAAA,CAAI,CAAGrB,CAAK,CAACC,OAAN,GAAgB,CAAhB,CADgC,CAEvCK,CAAO,CAAG,CAACe,CAAI,CAACvC,aAAL,CAAmB8B,UAAUU,MAAV,CAAiBhB,OAApC,GAAgD,CAACiB,KAAK,CAAE,EAAR,CAAjD,EAA8DA,KAFjC,CAIrC,GAAIjB,CAAJ,CAAa,CACTkB,CAAc,CACVlB,CADU,CAEV1B,CAAQ,CAACuB,OAAT,CAAiBsB,MAFP,CAGV7C,CAAQ,CAACuB,OAAT,CAAiBD,QAHP,CAIVtB,CAAQ,CAACuB,OAAT,CAAiBuB,SAJP,CAKV9C,CAAQ,CAACuB,OAAT,CAAiBwB,WALP,CAMV/C,CAAQ,CAACuB,OAAT,CAAiByB,WANP,CAOV,WAA6B,IAA3BC,CAAAA,CAA2B,GAA3BA,OAA2B,KAAlBC,OAAkB,CAAlBA,CAAkB,YAAR,EAAQ,GACzB9B,CAAK,CAAC+B,IAAN,GACA,GAAIF,CAAJ,CAAa,CACTG,UAAaC,eAAb,CAA6B,CACzBH,OAAO,CAAEA,CADgB,CAEzBnC,IAAI,CAAE,SAFmB,CAA7B,EAIAuC,QAAQ,CAACC,MAAT,EACH,CAND,IAMO,CACHH,UAAaI,KAAb,CAAmB,EAAnB,CAAuBN,CAAvB,CACH,CACJ,CAlBS,CAoBjB,CArBD,IAqBO,CACH,iBAAU,mBAAV,CAA+B,cAA/B,EAA+CO,IAA/C,CAAoD,SAAAP,CAAO,CAAI,CAC3D,MAAO,UAASA,CAAT,CACV,CAFD,CAGH,CAET9C,CAAC,CAACC,cAAF,EACH,CAhCD,EAkCAe,CAAK,CAACd,IAAN,EACH,CAtED,CAuEH,CAzED,CA0EH,C,CAcKsC,CAAc,4CAAG,WAAMlB,CAAN,CAAemB,CAAf,CAAuBvB,CAAvB,CAAiCwB,CAAjC,CAA4CC,CAA5C,CAAyDC,CAAzD,CAAsEU,CAAtE,oMACsBhC,CADtB,mOACsBA,CADtB,sDACsBA,CADtB,6BACbiC,CADa,QAGnBA,CAAa,CAACC,OAAd,CAAsBf,CAAtB,CAA8BvB,CAA9B,CAAwCwB,CAAxC,CAAmDC,CAAnD,CAAgEC,CAAhE,CAA6EU,CAA7E,EAHmB,wCAAH,uD","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Contain the logic for the gateways modal.\n *\n * @module     core_payment/gateways_modal\n * @package    core_payment\n * @copyright  2019 Shamim Rezaie <shamim@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalFactory from 'core/modal_factory';\nimport Templates from 'core/templates';\nimport {get_string as getString} from 'core/str';\nimport {getGatewaysSupportingCurrency} from 'core_payment/repository';\nimport Selectors from './selectors';\nimport * as ModalEvents from 'core/modal_events';\nimport {add as addToast, addToastRegion} from 'core/toast';\nimport Notification from 'core/notification';\n\n/**\n * Register event listeners for the module.\n *\n * @param {string} nodeSelector The root to listen to.\n */\nexport const registerEventListeners = (nodeSelector) => {\n    const rootNode = document.querySelector(nodeSelector);\n\n    rootNode.addEventListener('click', (e) => {\n        e.preventDefault();\n        show(rootNode, {focusOnClose: e.target});\n    });\n};\n\n/**\n * Shows the gateway selector modal.\n *\n * @param {HTMLElement} rootNode\n * @param {Object} options - Additional options\n * @param {HTMLElement} options.focusOnClose The element to focus on when the modal is closed.\n */\nconst show = (rootNode, {\n    focusOnClose = null,\n} = {}) => {\n    Templates.render('core_payment/gateways_modal', {})\n    .done(content => {\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: getString('selectpaymenttype', 'core_payment'),\n            body: content,\n        })\n        .done(function(modal) {\n            addToastRegion(modal.getRoot()[0]);\n            const currency = rootNode.dataset.currency;\n            getGatewaysSupportingCurrency(currency)\n            .done(gateways => {\n                const context = {\n                    gateways: []\n                };\n\n                for (let gateway of gateways) {\n                    context.gateways.push(gateway);\n                }\n\n                Templates.render('core_payment/gateways', context)\n                    .done((html, js) => {\n                        Templates.replaceNodeContents(modal.getRoot().find(Selectors.regions.gatewaysContainer),\n                            html, js);\n                    });\n            });\n\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                // Destroy when hidden.\n                modal.destroy();\n                try {\n                    focusOnClose.focus();\n                } catch (e) {\n                    // eslint-disable-line\n                }\n            });\n\n            modal.getRoot().on(ModalEvents.save, function(e) {\n                const root = modal.getRoot()[0];\n                const gateway = (root.querySelector(Selectors.values.gateway) || {value: ''}).value;\n\n                        if (gateway) {\n                            processPayment(\n                                gateway,\n                                rootNode.dataset.amount,\n                                rootNode.dataset.currency,\n                                rootNode.dataset.component,\n                                rootNode.dataset.componentid,\n                                rootNode.dataset.description,\n                                ({success, message = ''}) => {\n                                    modal.hide();\n                                    if (success) {\n                                        Notification.addNotification({\n                                            message: message,\n                                            type: 'success',\n                                        });\n                                        location.reload();\n                                    } else {\n                                        Notification.alert('', message);\n                                    }\n                                },\n                            );\n                        } else {\n                            getString('nogatewayselected', 'core_payment').then(message => {\n                                return addToast(message);\n                            });\n                        }\n\n                e.preventDefault();\n            });\n\n            modal.show();\n        });\n    });\n};\n\n/**\n * Process payment using the selected gateway.\n *\n * @param {string} gateway The gateway to be used for payment\n * @param {number} amount Amount of payment\n * @param {string} currency The currency in the three-character ISO-4217 format\n * @param {string} component Name of the component that the componentid belongs to\n * @param {number} componentid An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @param {processPaymentCallback} callback The callback function to call when processing is finished\n * @returns {Promise<void>}\n */\nconst processPayment = async(gateway, amount, currency, component, componentid, description, callback) => {\n    const paymentMethod = await import(`pg_${gateway}/gateways_modal`);\n\n    paymentMethod.process(amount, currency, component, componentid, description, callback);\n};\n\n/**\n * The callback definition for processPayment.\n *\n * @callback processPaymentCallback\n * @param {bool} success\n * @param {string} message\n */\n"],"file":"gateways_modal.min.js"}