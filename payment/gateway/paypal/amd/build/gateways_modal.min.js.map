{"version":3,"sources":["../src/gateways_modal.js"],"names":["showPlaceholder","ModalFactory","types","CANCEL","Templates","render","type","body","create","modal","show","process","amount","currency","component","componentid","description","callback","Promise","all","Repository","getConfigForJs","paypalConfig","getRoot","on","ModalEvents","hidden","destroy","paypalScript","clientid","callExternalFunction","setBody","paypal","Buttons","createOrder","data","actions","order","purchase_units","currency_code","value","Truncate","truncate","length","stripTags","application_context","shipping_preference","brand_name","brandname","onApprove","authorize","then","authorization","authorizationID","payments","authorizations","id","Ajax","call","methodname","args","orderid","orderID","authorizationid","res","hide","getBody","jsFile","func","currentlyloaded","includes","script","document","createElement","readyState","onreadystatechange","onload","setAttribute","head","appendChild","push"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for PayPal content in the gateways modal.\n *\n * @module     pg_paypal/gateway_modal\n * @copyright  2020 Shamim Rezaie <shamim@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './repository';\nimport Templates from 'core/templates';\nimport Truncate from 'core/truncate';\nimport Ajax from 'core/ajax';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @returns {Promise<Modal>}\n */\nconst showPlaceholder = async() => {\n    const modal = await ModalFactory.create({\n        type: ModalFactory.types.CANCEL,\n        body: await Templates.render('pg_paypal/paypal_button_placeholder', {})\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {double} amount Amount of payment\n * @param {string} currency The currency in the three-character ISO-4217 format\n * @param {string} component Name of the component that the componentid belongs to\n * @param {number} componentid An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @param {processCallback} callback The callback function to call when processing is finished\n * @returns {Promise<void>}\n */\nexport const process = async(amount, currency, component, componentid, description, callback) => {\n\n    const [\n        modal,\n        paypalConfig,\n    ] = await Promise.all([\n        showPlaceholder(),\n        Repository.getConfigForJs(),\n    ]);\n\n    modal.getRoot().on(ModalEvents.hidden, () => {\n        // Destroy when hidden.\n        modal.destroy();\n    });\n\n    const paypalScript = `https://www.paypal.com/sdk/js?client-id=${paypalConfig.clientid}&currency=${currency}&intent=authorize`;\n\n    callExternalFunction(paypalScript, () => {\n        modal.setBody('<form></form>'); // This is a hack. Instead of emptying the body, we put an empty form there so the modal\n                                        // is not closed when user clicks outside of modal.\n        paypal.Buttons({ // eslint-disable-line\n            createOrder: function(data, actions) {\n                // This function sets up the details of the transaction, including the amount and line item details.\n                return actions.order.create({\n                    purchase_units: [{ // eslint-disable-line\n                        amount: {\n                            currency_code: currency, // eslint-disable-line\n                            value: amount\n                        },\n                        description: Truncate.truncate(description, {length: 127, stripTags: true}),\n                    }],\n                    application_context: { // eslint-disable-line\n                        shipping_preference: 'NO_SHIPPING', // eslint-disable-line\n                        brand_name: Truncate.truncate(paypalConfig.brandname, {length: 127, stripTags: true}), // eslint-disable-line\n                    },\n                });\n            },\n            onApprove: function(data, actions) {\n                // Authorize the transaction.\n                actions.order.authorize().then(function(authorization) {\n                    // Get the authorization id.\n                    const authorizationID = authorization.purchase_units[0].payments.authorizations[0].id;\n\n                    // Call your server to validate and capture the transaction.\n                    return Ajax.call([{\n                        methodname: 'pg_paypal_transaction_complete',\n                        args: {\n                            component,\n                            componentid,\n                            orderid: data.orderID,\n                            authorizationid: authorizationID,\n                        },\n                    }])[0]\n                    .then(function(res) {\n                        modal.hide();\n                        return callback(res);\n                    });\n                });\n            }\n        }).render(modal.getBody()[0]);\n    });\n};\n\n/**\n * The callback definition for process.\n *\n * @callback processCallback\n * @param {bool} success\n * @param {string} message\n */\n\n/**\n * Calls a function from an external javascript file.\n *\n * @param {string} jsFile URL of the external JavaScript file\n * @param {function} func The function to call\n */\nconst callExternalFunction = (jsFile, func) => {\n    // Check to see if this file has already been loaded. If so just go straight to the func.\n    if (callExternalFunction.currentlyloaded.includes(jsFile)) {\n        func();\n        return;\n    }\n\n    const script = document.createElement('script');\n\n    if (script.readyState) {\n        script.onreadystatechange = function() {\n            if (this.readyState == 'complete' || this.readyState == 'loaded') {\n                this.onreadystatechange = null;\n                func();\n            }\n        };\n    } else {\n        script.onload = function() {\n            func();\n        };\n    }\n\n    script.setAttribute('src', jsFile);\n    document.head.appendChild(script);\n\n    callExternalFunction.currentlyloaded.push(jsFile);\n};\n\n/**\n * Holds the list of external JavaScript files.\n *\n * @static\n * @type {Array}\n */\ncallExternalFunction.currentlyloaded = [];\n"],"file":"gateways_modal.min.js"}